<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task List</title>

  <!-- Bootstrap CSS -->
  <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    /* Notifications: keep these custom styles for the top-left corner popups */
    #notificationList {
      position: fixed;
      top: 10px;
      left: 10px;
      list-style-type: none;
      margin: 0;
      padding: 0;
      z-index: 9999;
      max-width: 250px;
    }
    #notificationList li {
      background: #fde073;
      border: 1px solid #fbd35d;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 5px;
      color: #333;
      box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.1);
    }

    /* If you want a different background color for the whole page, keep this: */
    body {
      background-color: #f9f9f9;
    }

    /* Optional: style for 'deleted' tasks */
    .deleted {
      text-decoration: line-through;
      color: red;
    }
  </style>
</head>
<body>

<!-- Container for entire page -->
<div class="container py-4">

  <h1 class="text-center mb-4">Task List (Live Updates)</h1>

  <!-- Row for Add a Task & Update a Task side by side -->
  <div class="row g-4">
    <!-- ADD TASK -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Add a Task</h5>
          <div class="mb-3">
            <label for="newTaskTitle" class="form-label">Task Title</label>
            <input type="text" id="newTaskTitle" class="form-control" placeholder="Enter task title" />
          </div>
          <div class="mb-3">
            <label for="newTaskDesc" class="form-label">Description (optional)</label>
            <input type="text" id="newTaskDesc" class="form-control" placeholder="Enter task description" />
          </div>
          <button class="btn btn-primary w-100" onclick="createTask()">Add Task</button>
        </div>
      </div>
    </div>

    <!-- UPDATE TASK -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Update a Task</h5>
          <div class="mb-3">
            <label for="updateTaskId" class="form-label">Task ID</label>
            <input type="text" id="updateTaskId" class="form-control" placeholder="Task ID" />
          </div>
          <div class="mb-3">
            <label for="updateTaskTitle" class="form-label">New Task Title</label>
            <input type="text" id="updateTaskTitle" class="form-control" placeholder="New Task Title" />
          </div>
          <div class="mb-3">
            <label for="updateTaskDesc" class="form-label">New Description</label>
            <input type="text" id="updateTaskDesc" class="form-control" placeholder="New Task Description" />
          </div>
          <button class="btn btn-warning w-100" onclick="updateTask()">Update Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks List Section -->
  <div class="mt-5">
    <h2 class="mb-3">Tasks</h2>
    <ul id="taskList" class="list-unstyled"></ul>
  </div>

  <!-- Notification list (custom position in top-left corner) -->
  <ul id="notificationList"></ul>

</div><!-- /.container -->

<script>
  let socket;
  let users = [];

  // Connect Socket.io
  function connectWebSocket() {
    if (!socket) {
      socket = io();
      socket.on('connect', () => console.log('WebSocket connected!'));
      socket.on('taskCreated',  (task)   => updateTaskList(task, 'created'));
      socket.on('taskUpdated',  (task)   => updateTaskList(task, 'updated'));
      socket.on('taskDeleted',  (taskId) => updateTaskList({ _id: taskId }, 'deleted'));
      socket.on('notification', (data)   => displayNotification(data.message));
    }
  }

  // Display a notification in top-left corner
  function displayNotification(message) {
    const notificationList = document.getElementById('notificationList');
    const li = document.createElement('li');
    li.textContent = message;
    notificationList.appendChild(li);
    // Auto-remove after 15 seconds
    setTimeout(() => li.remove(), 15000);
  }

  // Update or create a task in DOM
  function updateTaskList(task, action) {
    const taskList = document.getElementById('taskList');
    let li = document.getElementById(task._id);

    if (action === 'created') {
      // Create new DOM element
      li = document.createElement('li');
      li.id = task._id;
      li.innerHTML = buildTaskHTML(task);
      taskList.appendChild(li);

    } else if (li) {
      if (action === 'updated') {
        // Replace existing DOM element
        li.innerHTML = buildTaskHTML(task);
      } else if (action === 'deleted') {
        // Mark as deleted
        li.classList.add('deleted');
        li.textContent += ' (Deleted)';
      }
    }
  }

  // Helper for building the Task's HTML
  function buildTaskHTML(task) {
    // Format the date nicely, or fallback to 'N/A'
    const createdDate = task.createdAt
            ? new Date(task.createdAt).toLocaleString()
            : 'N/A';

    return `
    <div class="p-3 mb-2 bg-white shadow-sm rounded">
      <div><strong>ID:</strong> ${task._id}</div>
      <div><strong>Title:</strong> ${task.title}</div>
      <div><strong>Description:</strong> ${task.description}</div>
      <div><strong>Created At:</strong> ${createdDate}</div>

      <!-- Use Bootstrap's flex utilities to align Status and Assigned side by side -->
      <div class="d-flex align-items-center gap-3 mt-2">
        <!-- Status Dropdown -->
        <div>
          <label class="me-1 fw-bold">Status:</label>
          <select
            class="form-select d-inline-block w-auto"
            onchange="updateTaskStatus('${task._id}', this.value)"
          >
            <option value="in progress" ${task.status === 'in progress' ? 'selected' : ''}>
              In Progress
            </option>
            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>
              Completed
            </option>
          </select>
        </div>

        <!-- Assigned Dropdown -->
        <div>
          <label class="me-1 fw-bold">Assign to:</label>
          <select
            class="form-select d-inline-block w-auto"
            onchange="updateTaskUser('${task._id}', this.value)"
          >
            ${users.map(u => `
              <option value="${u._id}" ${task.assignedUser == u._id ? 'selected' : ''}>
                ${u.username}
              </option>`).join('')}
          </select>
        </div>

        <!-- Delete Button -->
        <button
          class="btn btn-danger btn-sm"
          onclick="deleteTask('${task._id}')"
        >
          Delete
        </button>
      </div>
    </div>
  `;
  }

  // Load users from /api/users
  function loadUsers() {
    fetch('/api/users')
            .then(res => res.json())
            .then(data => {
              users = data;
              console.log('Loaded users:', users);
            })
            .catch(err => console.error('Error fetching users:', err));
  }

  // Check if user is authenticated, then connect websockets & fetch tasks
  function checkAuth() {
    fetch('/api/auth-check', { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
              if (data.authenticated) {
                connectWebSocket();
                fetchTasks();
              } else {
                window.location.href = '/login.html';
              }
            })
            .catch(err => console.error('Auth check failed:', err));
  }

  // Fetch tasks from /api/tasks and display them
  function fetchTasks() {
    fetch('/api/tasks')
            .then(res => res.json())
            .then(tasks => {
              tasks.forEach(task => updateTaskList(task, 'created'));
            })
            .catch(err => console.error('Error loading tasks:', err));
  }

  // CREATE a new task
  function createTask() {
    const taskTitleInput = document.getElementById('newTaskTitle');
    const taskDescInput  = document.getElementById('newTaskDesc');

    if (!taskTitleInput || !taskDescInput) {
      return console.error('Task input fields not found!');
    }

    const taskTitle = taskTitleInput.value;
    const taskDesc  = taskDescInput.value || 'No Description';

    if (!taskTitle) {
      return alert('Enter a task title');
    }

    fetch('/api/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title: taskTitle, description: taskDesc, status: 'in progress' })
    })
            .then(res => res.json())
            .then(task => {
              console.log('Task Created:', task);
              resetFields(['newTaskTitle', 'newTaskDesc']);
              // The 'taskCreated' socket event from server will also cause update
            })
            .catch(err => console.error('Error creating task:', err));
  }

  // UPDATE status only
  function updateTaskStatus(taskId, newStatus) {
    fetch(`/api/tasks/${taskId}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    })
            .then(res => res.json())
            .then(data => {
              console.log('Task updated:', data);
              updateTaskList(data, 'updated');
            })
            .catch(err => console.error('Error updating task status:', err));
  }

  // DELETE task
  function deleteTask(taskId) {
    fetch(`/api/tasks/${taskId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(() => {
              console.log('Task Deleted:', taskId);
              // The 'taskDeleted' socket event from server triggers DOM update
            })
            .catch(err => console.error('Error deleting task:', err));
  }

  // UPDATE assigned user
  function updateTaskUser(taskId, userId) {
    fetch(`/api/tasks/${taskId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ assignedUser: userId })
    })
            .then(res => res.json())
            .then(updatedTask => {
              console.log('Task user updated:', updatedTask);
              updateTaskList(updatedTask, 'updated');
            })
            .catch(err => console.error('Error updating user:', err));
  }

  // UPDATE title/description
  function updateTask() {
    const taskId    = document.getElementById('updateTaskId').value;
    const taskTitle = document.getElementById('updateTaskTitle').value;
    const taskDesc  = document.getElementById('updateTaskDesc').value || 'No Description';

    if (!taskId)    return alert('Enter a Task ID');
    if (!taskTitle) return alert('Enter a new Task Title');

    fetch(`/api/tasks/${taskId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title: taskTitle, description: taskDesc })
    })
            .then(res => res.json())
            .then(updatedTask => {
              console.log('Task updated:', updatedTask);
              updateTaskList(updatedTask, 'updated');
              resetFields(['updateTaskId','updateTaskTitle','updateTaskDesc']);
            })
            .catch(err => console.error('Error updating task:', err));
  }

  // Helper to clear out form fields
  function resetFields(fieldIds) {
    fieldIds.forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = '';
    });
  }

  // On page load
  window.onload = function () {
    checkAuth();  // if authenticated => connectWebSocket(), fetchTasks()
    loadUsers();  // fetch the user list
  };
</script>

<!-- Optionally, include Bootstrap JS for advanced features like modals, dropdowns, etc. -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>